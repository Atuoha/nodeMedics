'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),Doctor=require("../../models/Doctor"),User=require("../../models/User"),Department=require("../../models/Department"),Appointment=require("../../models/Appointment"),{isEmpty,uploadDir}=require("../../helpers/upload-helpers"),fs=require("fs");router.all("/*",(b,c,a)=>{b.app.locals.layout="admin";a()});
router.get("/",(b,c)=>{Appointment.find().populate("user").populate("department").populate("doctor").then(a=>{c.render("admin/appointment",{appointments:a})}).catch(a=>console.log(a))});router.get("/create",(b,c)=>{Doctor.find().then(a=>{Department.find().then(d=>{c.render("admin/appointment/create",{doctors:a,depts:d})}).catch(d=>console(`Error pulling depts ${d}`))}).catch(a=>console(`Error pulling doctors ${a}`))});
router.get("/:id",(b,c)=>{Appointment.find({user:b.user.id}).populate("user").populate("department").populate("doctor").then(a=>{c.render("admin/appointment/loggedUser_Appointments",{appointments:a})}).catch(a=>console.log(a))});router.get("/cancelled",(b,c)=>{Appointment.find().populate("user").populate("department").populate("doctor").then(a=>{c.render("admin/appointment/cancelled",{appointments:a})}).catch(a=>console.log(a))});
router.get("/cancelled/:id",(b,c)=>{Appointment.find({user:b.user.id}).populate("user").populate("department").populate("doctor").then(a=>{c.render("admin/appointment/loggedUser_CancelledAppoints",{appointments:a})}).catch(a=>console.log(a))});router.get("/show/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).populate("user").populate("department").populate("doctor").then(a=>{c.render("admin/appointment/show",{appointment:a})}).catch(a=>console.log(a))});
router.get("/edit/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).then(a=>{Doctor.find().then(d=>{Department.find().then(e=>{c.render("admin/appointment/edit",{appointment:a,doctors:d,depts:e})}).catch(e=>console.log(e))}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.post("/create",(b,c)=>{const a=new Appointment;a.user=b.user.id;a.doctor=b.body.doctor;a.department=b.body.department;a.date=b.body.date;a.message=b.body.message;a.save().then(d=>{b.flash("success_msg","Appointment created successfully :)");"Admin"===b.user.role?c.redirect("/admin/appointment"):c.redirect(`/admin/appointment/${b.user.id}`)}).catch(d=>console.log(d))});
router.post("/update/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).then(a=>{a.date=b.body.date;a.department=b.body.department;a.doctor=b.body.doctor;a.message=b.body.message;a.save().then(d=>{b.flash("success_msg","Appointment has been updated successfully :)");"Admin"===b.user.role?c.redirect("/admin/appointment"):c.redirect(`/admin/appointment/${b.user.id}`)})}).catch(a=>console.log(a))});
router.get("/delete/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).then(a=>{a.delete().then(d=>{b.flash("success_msg","Appointment has successfully been deleted :)");"Admin"===b.user.role?c.redirect("/admin/appointment"):c.redirect(`/admin/appointment/${b.user.id}`)})}).catch(a=>console.log(a))});
router.get("/retrieve/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).then(a=>{a.status="Active";a.save().then(d=>{b.flash("success_msg","Appointment has successfully been retrieved");"Admin"===b.user.role?c.redirect("/admin/appointment"):c.redirect(`/admin/appointment/${b.user.id}`)})}).catch(a=>console.log(a))});
router.get("/cancel/:id",(b,c)=>{Appointment.findOne({_id:b.params.id}).then(a=>{a.status="Unactive";a.save().then(d=>{b.flash("success_msg","Appointment has successfully been cancelled :)");"Admin"===b.user.role?c.redirect("/admin/appointment/cancelled"):c.redirect(`/admin/appointment/cancelled/${b.user.id}`)})}).catch(a=>console.log(a))});
router.post("/multiaction",(b,c)=>{console.log(b.body.checkboxes);Appointment.find({_id:b.body.checkboxes}).then(a=>{a.forEach(d=>{"cancel"===b.body.action?(d.status="Unactive",d.save().then(e=>{b.flash("success_msg","Appointment(s) cancelled successfully");"Admin"===b.user.role?c.redirect("/admin/appointment/cancelled"):c.redirect(`/admin/appointment/cancelled/${b.user.id}`)}).catch(e=>console.log(e))):d.delete().then(e=>{b.flash("success_msg","Appointment(s) deleted successfully");"Admin"===b.user.role?
c.redirect("/admin/appointment"):c.redirect(`/admin/appointment/${b.user.id}`)}).catch(e=>console.log(e))})}).catch(a=>console.log(a))});
router.post("/cancelled_multiaction",(b,c)=>{console.log(b.body.checkboxes);Appointment.find({_id:b.body.checkboxes}).then(a=>{a.forEach(d=>{"retrieve"===b.body.action?(d.status="Active",d.save().then(e=>{b.flash("success_msg","Appointment(s) retrieved successfully");c.redirect("/admin/appointment")}).catch(e=>console.log(e))):d.delete().then(e=>{b.flash("success_msg","Appointment(s) deleted successfully");c.redirect("back")}).catch(e=>console.log(e))})}).catch(a=>console.log(a))});
module.exports=router;