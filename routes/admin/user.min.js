'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),User=require("../../models/User"),fs=require("fs"),{isEmpty}=require("../../helpers/upload-helpers"),bcrypt=require("bcryptjs");router.all("/*",(a,d,b)=>{a.app.locals.layout="admin";b()});router.get("/",(a,d)=>{User.find().then(b=>{d.render("admin/users",{users:b})}).catch(b=>console.log(b))});router.get("/create",(a,d)=>{d.render("admin/users/create")});router.get("/dummy",(a,d)=>{d.render("admin/users/dummy")});
router.get("/edit/:id",(a,d)=>{User.findOne({_id:a.params.id}).then(b=>{d.render("admin/users/edit",{user:b})}).catch(b=>console.log(b))});router.get("/profile/:id",(a,d)=>{User.findOne({_id:a.params.id}).then(b=>{d.render("admin/profile",{profile:b})}).catch(b=>console.log(b))});router.get("/show/:id",(a,d)=>{User.findOne({_id:a.params.id}).then(b=>{d.render("admin/users/show",{user:b})}).catch(b=>console.log(b))});
router.post("/create",(a,d)=>{let b="";if(!isEmpty(a.files)){let e=a.files.file;b=Date.now()+"-"+e.name;e.mv("./public/uploads/"+b,f=>{f&&console.log(f)})}const c=new User;c.name=a.body.name;c.email=a.body.email;c.phone=a.body.phone;c.role=a.body.role;c.status=a.body.status;c.file=b;c.password=a.body.password;bcrypt.genSalt(10,(e,f)=>{bcrypt.hash(a.body.password,f,(h,k)=>{h&&console.log(h);c.password=k;c.save().then(g=>{a.flash("success_msg",`${g.name} has been created as a user successfully :)`);
d.redirect("/admin/users")}).catch(g=>console.log(g))})})});
router.post("/dummy",(a,d)=>{for(let b=0;b<a.body.number;b++){const c=new User;c.name=faker.name.firstName()+" "+faker.name.lastName();c.email=faker.internet.email();c.phone="+234-000-0000-000";c.role="Subscriber";c.status="Active";c.file="default.png";c.password="secret";bcrypt.genSalt(10,(e,f)=>{bcrypt.hash("secret",f,(h,k)=>{h&&console.log(h);c.password=k;c.save().then(g=>{a.flash("success_msg",`${a.body.number} dummy users has been created as users successfully :)`);d.redirect("/admin/users")}).catch(g=>
console.log(g))})})}});
router.post("/update/:id",(a,d)=>{User.findOne({_id:a.params.id}).then(b=>{let c=b.file;if(!isEmpty(a.files)){let e=a.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"default.png"!==b.file&&""!==b.file&&fs.unlink("./public/uploads/"+b.file,f=>{f&&console.log(`eRROR removing file: ${f}`)})}a.body.password?(b.name=a.body.name,b.email=a.body.email,b.phone=a.body.phone,b.role=a.body.role,b.status=a.body.status,b.file=c,b.password=a.body.password,bcrypt.genSalt(10,
(e,f)=>{bcrypt.hash(a.body.password,f,(h,k)=>{h&&console.log(h);b.password=k;b.save().then(g=>{a.flash("success_msg","Update was successfully :)");d.redirect("back")}).catch(g=>console.log(g))})})):(b.name=a.body.name,b.email=a.body.email,b.phone=a.body.phone,b.role=a.body.role,b.status=a.body.status,b.file=c,b.save().then(e=>{a.flash("success_msg","Update was successfully :)");"Admin"===loggedUser.role?d.redirect("/admin/users"):d.redirect(`/admin/users/profile/${a.user.id}`)}).catch(e=>console.log(e)))}).catch(b=>
console.log(`Can't find user ${b}`))});router.get("/delete/:id",(a,d)=>{User.findOne({_id:a.params.id}).then(b=>{"default.png"!==b.file&&""!==b.file&&fs.unlink("./public/uploads/"+b.file,c=>{c&&console.log(`eRROR removing file: ${c}`)});b.delete().then(c=>{a.flash("success_msg",`${c.name} was successfully deleted :)`);d.redirect("/admin/users")}).catch(c=>console.log(c))}).catch(b=>console.log(b))});
router.post("/multiaction",(a,d)=>{console.log(a.body.checkboxes);User.find({_id:a.body.checkboxes}).then(b=>{b.forEach(c=>{"cancel"===a.body.action?(c.status="Unactive",c.save().then(e=>{a.flash("success_msg","user(s) cancelled successfully");"Admin"===a.user.role?d.redirect("/admin/user/cancelled"):d.redirect(`/admin/user/cancelled/${a.user.id}`)}).catch(e=>console.log(e))):c.delete().then(e=>{a.flash("success_msg","user(s) deleted successfully");"Admin"===a.user.role?d.redirect("/admin/user"):
d.redirect(`/admin/user/${a.user.id}`)}).catch(e=>console.log(e))})}).catch(b=>console.log(b))});module.exports=router;