'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),User=require("../../models/User"),fs=require("fs"),{isEmpty}=require("../../helpers/upload-helpers"),bcrypt=require("bcryptjs");router.all("/*",(b,d,a)=>{b.app.locals.layout="admin";a()});router.get("/",(b,d)=>{User.find().then(a=>{d.render("admin/users",{users:a})}).catch(a=>console.log(a))});router.get("/create",(b,d)=>{d.render("admin/users/create")});router.get("/dummy",(b,d)=>{d.render("admin/users/dummy")});
router.get("/edit/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{d.render("admin/users/edit",{user:a})}).catch(a=>console.log(a))});router.get("/profile/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{d.render("admin/profile",{profile:a})}).catch(a=>console.log(a))});router.get("/show/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{d.render("admin/users/show",{user:a})}).catch(a=>console.log(a))});
router.post("/create",(b,d)=>{let a="";if(!isEmpty(b.files)){let e=b.files.file;a=Date.now()+"-"+e.name;e.mv("./public/uploads/"+a,f=>{f&&console.log(f)})}const c=new User;c.name=b.body.name;c.email=b.body.email;c.phone=b.body.phone;c.role=b.body.role;c.status=b.body.status;c.file=a;c.password=b.body.password;bcrypt.genSalt(10,(e,f)=>{bcrypt.hash(b.body.password,f,(h,k)=>{h&&console.log(h);c.password=k;c.save().then(g=>{b.flash("success_msg",`${g.name} has been created as a user successfully :)`);
d.redirect("/admin/users")}).catch(g=>console.log(g))})})});
router.post("/dummy",(b,d)=>{for(let a=0;a<b.body.number;a++){const c=new User;c.name=faker.name.firstName()+" "+faker.name.lastName();c.email=faker.internet.email();c.phone="+234-000-0000-000";c.role="Subscriber";c.status="Active";c.file="default.png";c.password="secret";bcrypt.genSalt(10,(e,f)=>{bcrypt.hash("secret",f,(h,k)=>{h&&console.log(h);c.password=k;c.save().then(g=>{b.flash("success_msg",`${b.body.number} dummy users has been created as users successfully :)`);d.redirect("/admin/users")}).catch(g=>
console.log(g))})})}});
router.post("/update/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){let e=b.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"default.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(`eRROR removing file: ${f}`)})}b.body.password?(a.name=b.body.name,a.email=b.body.email,a.phone=b.body.phone,a.role=b.body.role,a.status=b.body.status,a.file=c,a.password=b.body.password,bcrypt.genSalt(10,
(e,f)=>{bcrypt.hash(b.body.password,f,(h,k)=>{h&&console.log(h);a.password=k;a.save().then(g=>{b.flash("success_msg","Update was successfully :)");d.redirect("back")}).catch(g=>console.log(g))})})):(a.name=b.body.name,a.email=b.body.email,a.phone=b.body.phone,a.role=b.body.role,a.status=b.body.status,a.file=c,a.save().then(e=>{b.flash("success_msg","Update was successfully :)");"Admin"===loggedUser.role?d.redirect("/admin/users"):d.redirect(`/admin/users/profile/${b.user.id}`)}).catch(e=>console.log(e)))}).catch(a=>
console.log(`Can't find user ${a}`))});router.get("/delete/:id",(b,d)=>{User.findOne({_id:b.params.id}).then(a=>{"default.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{c&&console.log(`eRROR removing file: ${c}`)});a.delete().then(c=>{b.flash("success_msg",`${c.name} was successfully deleted :)`);d.redirect("/admin/users")}).catch(c=>console.log(c))}).catch(a=>console.log(a))});
router.post("/multiaction",(b,d)=>{console.log(b.body.checkboxes);User.find({_id:b.body.checkboxes}).then(a=>{a.forEach(c=>{"unactive"===b.body.action?(c.status="Unactive",c.save().then(e=>{b.flash("success_msg","Users updated successfully");d.redirect("/admin/user")}).catch(e=>console.log(e))):"active"===b.body.action?(c.status="Active",c.save().then(e=>{b.flash("success_msg","Users updated successfully");d.redirect("/admin/user")}).catch(e=>console.log(e))):("default.png"!==user.file&&fs.unlink("./public/uploads/"+
user.file,e=>{e&&console.log(e)}),c.delete().then(e=>{b.flash("success_msg","user(s) deleted successfully");d.redirect("/admin/user")}).catch(e=>console.log(e)))})}).catch(a=>console.log(a))});module.exports=router;