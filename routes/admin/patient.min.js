'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),Patient=require("../../models/Patient"),fs=require("fs"),{isEmpty}=require("../../helpers/upload-helpers");router.all("/*",(b,e,a)=>{b.app.locals.layout="admin";a()});router.get("/",(b,e)=>{Patient.find().then(a=>{e.render("admin/patient",{patients:a})}).catch(a=>console.log(a))});router.get("/create",(b,e)=>{e.render("admin/patient/create")});router.get("/dummy",(b,e)=>{e.render("admin/patient/dummy")});
router.get("/edit/:id",(b,e)=>{Patient.findOne({_id:b.params.id}).then(a=>{e.render("admin/patient/edit",{patient:a})}).catch(a=>console.log(a))});router.get("/show/:id",(b,e)=>{Patient.findOne({_id:b.params.id}).then(a=>{e.render("admin/patient/show",{patient:a})}).catch(a=>console.log(a))});
router.post("/create",(b,e)=>{let a="";if(!isEmpty(b.files)){var c=b.files.file;a=Date.now()+"-"+c.name;c.mv("./public/uploads/"+a,d=>{d&&console.log(d)})}c=new Patient;c.name=b.body.name;c.email=b.body.email;c.phone=b.body.phone;c.entry_date=b.body.entry_date;c.discharge_date=b.body.discharge_date;c.file=a;c.note=b.body.note;c.save().then(d=>{b.flash("success_msg",`${d.name} has been created as a patient successfully :)`);e.redirect("/admin/patient")}).catch(d=>console.log(d))});
router.post("/dummy",(b,e)=>{for(let a=0;a<b.body.number;a++){const c=new Patient;c.name=faker.name.firstName()+" "+faker.name.lastName();c.email=faker.internet.email();c.phone="+234-000-0000-000";c.entry_date=new Date;c.discharge_date=new Date;c.file="default.png";c.note=faker.lorem.sentence();c.save().then(d=>{b.flash("success_msg",`${b.body.number} dummy patients has been created as patients successfully :)`);e.redirect("/admin/patient")}).catch(d=>console.log(d))}});
router.post("/update/:id",(b,e)=>{Patient.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){let d=b.files.file;c=Date.now()+"-"+d.name;d.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"default.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(`eRROR removing file: ${f}`)})}a.name=b.body.name;a.email=b.body.email;a.phone=b.body.phone;a.entry_date=b.body.entry_date;a.discharge_date=b.body.discharge_date;a.file=c;a.note=b.body.note;a.save().then(d=>
{b.flash("success_msg","Update was successfully :)");e.redirect("/admin/patient")}).catch(d=>console.log(d))}).catch(a=>console.log(`Can't find patient ${a}`))});
router.get("/delete/:id",(b,e)=>{Patient.findOne({_id:b.params.id}).then(a=>{"default.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{c&&console.log(`eRROR removing file: ${c}`)});a.delete().then(c=>{b.flash("success_msg",`${c.name} was successfully deleted :)`);e.redirect("/admin/patient")}).catch(c=>console.log(c))}).catch(a=>console.log(a))});
router.post("/multiaction",(b,e)=>{console.log(b.body.checkboxes);Patient.find({_id:b.body.checkboxes}).then(a=>{a.forEach(c=>{"discharged"===b.body.action?(c.status="Discharged",c.save().then(d=>{b.flash("success_msg","patients updated successfully");e.redirect("/admin/patient")}).catch(d=>console.log(d))):"active"===b.body.action?(c.status="Active",c.save().then(d=>{b.flash("success_msg","patients updated successfully");e.redirect("/admin/patient")}).catch(d=>console.log(d))):("default.png"!==c.file&&
fs.unlink("./public/uploads/"+c.file,d=>{d&&console.log(d)}),c.delete().then(d=>{b.flash("success_msg","patient(s) deleted successfully");e.redirect("/admin/patient")}).catch(d=>console.log(d)))})}).catch(a=>console.log(a))});module.exports=router;