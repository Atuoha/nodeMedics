'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),Research=require("../../models/Research"),{isEmpty,uploadDir}=require("../../helpers/upload-helpers"),fs=require("fs");router.all("/*",(b,d,a)=>{b.app.locals.layout="admin";a()});router.get("/",(b,d)=>{Research.find().then(a=>{d.render("admin/research_lab",{labs:a})}).catch(a=>console.log(a))});router.get("/create",(b,d)=>{d.render("admin/research_lab/create")});router.get("/dummy",(b,d)=>{d.render("admin/research_lab/dummy")});
router.post("/create",(b,d)=>{let a="";if(!isEmpty(b.files)){var c=b.files.file;a=Date.now()+"-"+c.name;c.mv("./public/uploads/"+a,e=>{e&&console.log(e)})}c=new Research;c.name=b.body.name;c.location=b.body.location;c.date=b.body.date;c.intro=b.body.intro;c.content=b.body.content;c.tag=b.body.tag;c.file=a;c.save().then(e=>{b.flash("success_msg",`${e.name} Research Lab registered successfully :)`);d.redirect("/admin/labs")}).catch(e=>console.log(e))});
router.post("/dummy",(b,d)=>{for(let a=0;a<b.body.number;a++){const c=new Research;c.name=faker.name.title();c.location=faker.random.word();c.content=faker.lorem.sentence();c.intro=faker.lorem.sentence();c.tag=faker.random.word();c.file="img_place.png";c.date=new Date;c.save().then(e=>{b.flash("success_msg",`${b.body.number} Dummy Labs registered successfully :)`);d.redirect("/admin/labs")}).catch(e=>console.log(e))}});
router.get("/edit/:id",(b,d)=>{Research.findOne({_id:b.params.id}).then(a=>{d.render("admin/research_lab/edit",{lab:a})}).catch(a=>console.log(a))});router.get("/show/:id",(b,d)=>{Research.findOne({_id:b.params.id}).then(a=>{d.render("admin/research_lab/show",{lab:a})}).catch(a=>console.log(a))});
router.post("/update/:id",(b,d)=>{Research.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files)){let e=b.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(f)})}a.name=b.body.name;a.tag=b.body.tag;a.location=b.body.location;a.date=b.body.date;a.intro=b.body.intro;a.content=b.body.content;a.file=c;a.save().then(e=>{b.flash("success_msg",`${a.name} has been updated successfully :)`);
d.redirect("/admin/labs")})}).catch(a=>console.log(a))});router.get("/delete/:id",(b,d)=>{Research.findOne({_id:b.params.id}).then(a=>{"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{c&&console.log(c)});a.delete().then(c=>{b.flash("success_msg",`${c.name} Lab Deleted successfully :)`);d.redirect("/admin/labs")}).catch(c=>console.log(`Can't delete due to ${c}`))}).catch(a=>console.log(a))});module.exports=router;